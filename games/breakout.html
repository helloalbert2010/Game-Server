<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰“ç –å— - ä¸“æ³¨åŠ›è®­ç»ƒå¹³å°</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .breakout-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .back-button {
      margin-bottom: 20px;
    }

    .game-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .game-area {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .game-canvas-wrapper {
      background: var(--darker-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }

    #gameCanvas {
      display: block;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: linear-gradient(to bottom, #1e293b, #0f172a);
    }

    .game-info-panel {
      min-width: 220px;
    }

    .info-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      text-align: center;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .info-value {
      font-size: 36px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .info-value.level {
      color: var(--warning-color);
    }

    .info-value.points {
      color: var(--secondary-color);
    }

    .game-controls-panel {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
    }

    .control-btn {
      display: block;
      width: 100%;
      padding: 12px 24px;
      margin-bottom: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-start {
      background: var(--primary-color);
      color: white;
    }

    .btn-start:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-pause {
      background: var(--warning-color);
      color: white;
    }

    .btn-pause:hover {
      background: #d97706;
    }

    .btn-reset {
      background: var(--danger-color);
      color: white;
    }

    .btn-reset:hover {
      background: #dc2626;
    }

    .instructions {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .instructions h3 {
      color: var(--primary-color);
      margin-bottom: 12px;
    }

    .instructions ul {
      list-style-position: inside;
      color: var(--text-secondary);
    }

    .instructions li {
      margin: 8px 0;
    }

    .result-display {
      text-align: center;
      padding: 24px;
      background: var(--darker-bg);
      border-radius: 12px;
      margin-top: 20px;
      display: none;
    }

    .result-display.active {
      display: block;
    }

    .result-score {
      font-size: 48px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .result-message {
      font-size: 20px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .result-points {
      font-size: 28px;
      color: var(--warning-color);
      font-weight: bold;
    }

    .lives-display {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }

    .life-icon {
      font-size: 24px;
      color: var(--danger-color);
    }

    .leaderboard-section {
      margin-top: 30px;
    }

    @media (max-width: 768px) {
      .game-area {
        flex-direction: column;
        align-items: center;
      }

      #gameCanvas {
        max-width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body data-auth-required="true">
  <div class="breakout-container">
    <div class="back-button">
      <a href="/lobby" class="btn btn-outline">â† è¿”å›å¤§å…</a>
    </div>

    <div class="game-header">
      <h1>ğŸ§± ç»å…¸æ‰“ç –å—</h1>
      <p style="color: var(--text-secondary);">æ§åˆ¶æŒ¡æ¿åå¼¹çƒï¼Œå‡»ç¢æ‰€æœ‰ç –å—ï¼</p>
    </div>

    <div class="instructions">
      <h3>ğŸ“‹ æ¸¸æˆè¯´æ˜</h3>
      <ul>
        <li>ä½¿ç”¨é¼ æ ‡æˆ–å·¦å³ç®­å¤´é”®æ§åˆ¶æŒ¡æ¿ç§»åŠ¨</li>
        <li>å‡»ç¢ç –å—å¾—åˆ†ï¼Œä¸åŒé¢œè‰²ç –å—åˆ†æ•°ä¸åŒ</li>
        <li>çƒæ‰è½åº•éƒ¨å¤±å»ä¸€æ¡ç”Ÿå‘½</li>
        <li>3æ¡ç”Ÿå‘½ç”¨å®Œæ¸¸æˆç»“æŸ</li>
      </ul>
    </div>

    <div class="game-area">
      <div class="game-canvas-wrapper">
        <canvas id="gameCanvas" width="600" height="500"></canvas>
      </div>

      <div class="game-info-panel">
        <div class="info-card">
          <div class="info-label">å½“å‰åˆ†æ•°</div>
          <div class="info-value" id="currentScore">0</div>
        </div>

        <div class="info-card">
          <div class="info-label">å½“å‰å…³å¡</div>
          <div class="info-value level" id="currentLevel">1</div>
        </div>

        <div class="info-card">
          <div class="info-label">å‰©ä½™ç”Ÿå‘½</div>
          <div class="lives-display" id="livesDisplay">
            <span class="life-icon">â¤ï¸</span>
            <span class="life-icon">â¤ï¸</span>
            <span class="life-icon">â¤ï¸</span>
          </div>
        </div>

        <div class="game-controls-panel">
          <button class="control-btn btn-start" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
          <button class="control-btn btn-pause" id="pauseBtn">æš‚åœ</button>
          <button class="control-btn btn-reset" id="resetBtn">é‡æ–°å¼€å§‹</button>
        </div>

        <div class="result-display" id="resultDisplay">
          <div class="result-score" id="resultScore">0</div>
          <div class="result-message" id="resultMessage"></div>
          <div class="result-points" id="resultPoints"></div>
        </div>
      </div>
    </div>

    <div class="card leaderboard-section">
      <h2 style="color: var(--secondary-color);">ğŸ† æ’è¡Œæ¦œ</h2>
      <div id="leaderboard-container">
        <div class="loading">åŠ è½½ä¸­</div>
      </div>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    // æ¸¸æˆé…ç½®
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // æ¸¸æˆå¯¹è±¡
    let ball = {};
    let paddle = {};
    let bricks = [];
    let gameLoop = null;
    let score = 0;
    let level = 1;
    let lives = 3;
    let gameState = 'idle'; // idle, playing, paused, gameOver

    // ç –å—é…ç½®
    const brickConfig = {
      rows: 5,
      cols: 8,
      width: 65,
      height: 20,
      padding: 8,
      offsetTop: 40,
      offsetLeft: 22
    };

    // ç –å—é¢œè‰²å’Œåˆ†æ•°
    const brickTypes = [
      { color: '#ef4444', points: 50 },
      { color: '#f59e0b', points: 40 },
      { color: '#10b981', points: 30 },
      { color: '#3b82f6', points: 20 },
      { color: '#8b5cf6', points: 10 }
    ];

    // DOM å…ƒç´ 
    const currentScoreEl = document.getElementById('currentScore');
    const currentLevelEl = document.getElementById('currentLevel');
    const livesDisplayEl = document.getElementById('livesDisplay');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultDisplay = document.getElementById('resultDisplay');

    // åˆå§‹åŒ–æ¸¸æˆ
    function init() {
      // åˆå§‹åŒ–çƒ
      ball = {
        x: canvas.width / 2,
        y: canvas.height - 50,
        dx: 4,
        dy: -4,
        radius: 8
      };

      // åˆå§‹åŒ–æŒ¡æ¿
      paddle = {
        width: 100,
        height: 12,
        x: (canvas.width - 100) / 2,
        speed: 8
      };

      score = 0;
      level = 1;
      lives = 3;

      updateUI();
      initBricks();
      draw();
    }

    // åˆå§‹åŒ–ç –å—
    function initBricks() {
      bricks = [];
      for (let row = 0; row < brickConfig.rows; row++) {
        for (let col = 0; col < brickConfig.cols; col++) {
          bricks.push({
            x: col * (brickConfig.width + brickConfig.padding) + brickConfig.offsetLeft,
            y: row * (brickConfig.height + brickConfig.padding) + brickConfig.offsetTop,
            width: brickConfig.width,
            height: brickConfig.height,
            color: brickTypes[row].color,
            points: brickTypes[row].points,
            visible: true
          });
        }
      }
    }

    // ç»˜åˆ¶æ¸¸æˆ
    function draw() {
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶çƒ
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.closePath();

      // ç»˜åˆ¶æŒ¡æ¿
      ctx.fillStyle = '#6366f1';
      ctx.fillRect(paddle.x, canvas.height - paddle.height - 10, paddle.width, paddle.height);

      // ç»˜åˆ¶ç –å—
      bricks.forEach(brick => {
        if (brick.visible) {
          ctx.fillStyle = brick.color;
          ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
          ctx.strokeStyle = 'rgba(255,255,255,0.2)';
          ctx.strokeRect(brick.x, brick.y, brick.width, brick.height);
        }
      });
    }

    // æ¸¸æˆå¾ªç¯
    function update() {
      // ç§»åŠ¨çƒ
      ball.x += ball.dx;
      ball.y += ball.dy;

      // å¢™å£ç¢°æ’æ£€æµ‹
      if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
        ball.dx = -ball.dx;
      }
      if (ball.y - ball.radius < 0) {
        ball.dy = -ball.dy;
      }

      // æŒ¡æ¿ç¢°æ’æ£€æµ‹
      if (ball.y + ball.radius > canvas.height - paddle.height - 10 &&
          ball.x > paddle.x &&
          ball.x < paddle.x + paddle.width) {
        ball.dy = -Math.abs(ball.dy);

        // æ ¹æ®å‡»ä¸­ä½ç½®è°ƒæ•´è§’åº¦
        const hitPos = (ball.x - paddle.x) / paddle.width;
        ball.dx = (hitPos - 0.5) * 8;
      }

      // ç –å—ç¢°æ’æ£€æµ‹
      bricks.forEach(brick => {
        if (brick.visible &&
            ball.x > brick.x &&
            ball.x < brick.x + brick.width &&
            ball.y > brick.y &&
            ball.y < brick.y + brick.height) {
          ball.dy = -ball.dy;
          brick.visible = false;
          score += brick.points;
          updateUI();
        }
      });

      // æ£€æŸ¥æ˜¯å¦å®Œæˆå…³å¡
      if (bricks.every(brick => !brick.visible)) {
        nextLevel();
        return;
      }

      // çƒæ‰è½åº•éƒ¨
      if (ball.y + ball.radius > canvas.height) {
        loseLife();
        return;
      }

      draw();
    }

    // ä¸‹ä¸€å…³
    function nextLevel() {
      level++;
      ball.dx *= 1.1;
      ball.dy *= 1.1;
      ball.x = canvas.width / 2;
      ball.y = canvas.height - 50;
      paddle.x = (canvas.width - paddle.width) / 2;
      initBricks();
      updateUI();
    }

    // å¤±å»ç”Ÿå‘½
    function loseLife() {
      lives--;
      updateUI();

      if (lives <= 0) {
        gameOver();
      } else {
        ball.x = canvas.width / 2;
        ball.y = canvas.height - 50;
        ball.dx = 4 * (1 + (level - 1) * 0.1);
        ball.dy = -4 * (1 + (level - 1) * 0.1);
        paddle.x = (canvas.width - paddle.width) / 2;
      }
    }

    // æ›´æ–°UI
    function updateUI() {
      currentScoreEl.textContent = score;
      currentLevelEl.textContent = level;

      // æ›´æ–°ç”Ÿå‘½æ˜¾ç¤º
      let livesHTML = '';
      for (let i = 0; i < lives; i++) {
        livesHTML += '<span class="life-icon">â¤ï¸</span>';
      }
      livesDisplayEl.innerHTML = livesHTML;
    }

    // å¼€å§‹æ¸¸æˆ
    function startGame() {
      if (gameState === 'playing') return;

      if (gameState === 'idle' || gameState === 'gameOver') {
        init();
      }

      gameState = 'playing';
      resultDisplay.classList.remove('active');
      startBtn.textContent = 'æ¸¸æˆä¸­...';
      startBtn.disabled = true;
      pauseBtn.disabled = false;

      gameLoop = setInterval(update, 16);
    }

    // æš‚åœæ¸¸æˆ
    function pauseGame() {
      if (gameState !== 'playing') return;

      clearInterval(gameLoop);
      gameState = 'paused';
      startBtn.textContent = 'ç»§ç»­æ¸¸æˆ';
      startBtn.disabled = false;
      pauseBtn.disabled = true;
    }

    // æ¸¸æˆç»“æŸ
    async function gameOver() {
      clearInterval(gameLoop);
      gameState = 'gameOver';

      const points = calculatePoints(score);

      // æ˜¾ç¤ºç»“æœ
      document.getElementById('resultScore').textContent = score + ' åˆ†';
      document.getElementById('resultMessage').textContent = `é€šè¿‡ ${level} å…³`;
      document.getElementById('resultPoints').textContent = `+${points} ç§¯åˆ†`;
      resultDisplay.classList.add('active');

      startBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
      startBtn.disabled = false;
      pauseBtn.disabled = true;

      // ä¸Šä¼ æˆç»©
      try {
        const result = await submitScore('breakout', score);
        document.getElementById('resultPoints').textContent = `+${result.totalPoints} ç§¯åˆ†`;
        loadLeaderboard();
      } catch (error) {
        console.error('æäº¤æˆç»©å¤±è´¥:', error);
      }
    }

    // è®¡ç®—ç§¯åˆ†
    function calculatePoints(score) {
      if (score >= 2000) return 100;
      if (score >= 1500) return 80;
      if (score >= 1000) return 60;
      if (score >= 500) return 40;
      return 20;
    }

    // é‡ç½®æ¸¸æˆ
    function resetGame() {
      clearInterval(gameLoop);
      gameState = 'idle';
      resultDisplay.classList.remove('active');
      startBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      init();
    }

    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', (e) => {
      if (gameState !== 'playing') return;

      if (e.key === 'ArrowLeft') {
        paddle.x = Math.max(0, paddle.x - paddle.speed * 2);
        e.preventDefault();
      } else if (e.key === 'ArrowRight') {
        paddle.x = Math.min(canvas.width - paddle.width, paddle.x + paddle.speed * 2);
        e.preventDefault();
      }
    });

    // é¼ æ ‡æ§åˆ¶
    canvas.addEventListener('mousemove', (e) => {
      if (gameState !== 'playing') return;

      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      paddle.x = Math.max(0, Math.min(canvas.width - paddle.width, mouseX - paddle.width / 2));
    });

    // æŒ‰é’®äº‹ä»¶
    startBtn.addEventListener('click', startGame);
    pauseBtn.addEventListener('click', pauseGame);
    resetBtn.addEventListener('click', resetGame);

    // åŠ è½½æ’è¡Œæ¦œ
    async function loadLeaderboard() {
      const container = document.getElementById('leaderboard-container');
      try {
        const leaderboard = await getLeaderboard('breakout');

        if (!leaderboard || leaderboard.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">æš‚æ— æ•°æ®</p>';
          return;
        }

        const html = `
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>ç”¨æˆ·</th>
                <th>åˆ†æ•°</th>
                <th>æ—¶é—´</th>
              </tr>
            </thead>
            <tbody>
              ${leaderboard.slice(0, 10).map((item, index) => `
                <tr>
                  <td class="rank-${index + 1}">#${index + 1}</td>
                  <td>${item.username}</td>
                  <td>${Math.floor(item.score)} åˆ†</td>
                  <td>${formatDate(item.played_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = '<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥</p>';
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      init();
      loadLeaderboard();
    });
  </script>
</body>
</html>
