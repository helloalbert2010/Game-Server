<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>F1 ååº”åŠ›æµ‹è¯• - ä¸“æ³¨åŠ›è®­ç»ƒå¹³å°</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .f1-game-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .lights-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 40px 0;
    }

    .light {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #1e293b;
      border: 4px solid #334155;
      transition: all 0.3s ease;
    }

    .light.on {
      background: #ef4444;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
    }

    .light.green {
      background: #10b981;
      box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
    }

    .result-display {
      text-align: center;
      margin: 40px 0;
      padding: 30px;
      background: var(--darker-bg);
      border-radius: 12px;
    }

    .result-time {
      font-size: 64px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .result-rank {
      font-size: 24px;
      color: var(--secondary-color);
      margin-bottom: 10px;
    }

    .result-f1 {
      font-size: 18px;
      color: var(--text-secondary);
    }

    .result-points {
      font-size: 32px;
      color: var(--warning-color);
      margin-top: 20px;
      font-weight: bold;
    }

    .status-message {
      text-align: center;
      font-size: 20px;
      color: var(--text-secondary);
      margin: 30px 0;
      min-height: 30px;
    }

    .controls {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 20px 0;
    }

    .game-instructions {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .game-instructions h3 {
      color: var(--primary-color);
      margin-bottom: 12px;
    }

    .game-instructions ul {
      list-style-position: inside;
      color: var(--text-secondary);
    }

    .game-instructions li {
      margin: 8px 0;
    }

    .back-button {
      margin-bottom: 20px;
    }
  </style>
</head>
<body data-auth-required="true">
  <div class="f1-game-container">
    <div class="back-button">
      <a href="/lobby" class="btn btn-outline">â† è¿”å›å¤§å…</a>
    </div>

    <div class="card">
      <h1 style="text-align: center; margin-bottom: 10px;">ğŸï¸ F1 ååº”åŠ›æµ‹è¯•</h1>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px;">
        æµ‹è¯•ä½ çš„èµ·æ­¥ååº”é€Ÿåº¦ï¼Œå¯¹æ¯” F1 è½¦æ‰‹ï¼
      </p>

      <div class="game-instructions">
        <h3>ğŸ“‹ æ¸¸æˆè¯´æ˜</h3>
        <ul>
          <li>ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æˆ–æŒ‰ç©ºæ ¼é”®å¼€å§‹</li>
          <li>ç­‰å¾…5ä¸ªçº¢ç¯ä¾æ¬¡äº®èµ·</li>
          <li>å½“æ‰€æœ‰çº¢ç¯ç†„ç­æ—¶ï¼Œç«‹å³ç‚¹å‡»æˆ–æŒ‰ç©ºæ ¼é”®</li>
          <li>ååº”æ—¶é—´è¶ŠçŸ­ï¼Œç§¯åˆ†è¶Šé«˜ï¼</li>
        </ul>
      </div>

      <div class="lights-container">
        <div class="light" id="light1"></div>
        <div class="light" id="light2"></div>
        <div class="light" id="light3"></div>
        <div class="light" id="light4"></div>
        <div class="light" id="light5"></div>
      </div>

      <div class="result-display" id="resultDisplay" style="display: none;">
        <div class="result-time" id="resultTime">--</div>
        <div class="result-rank" id="resultRank"></div>
        <div class="result-f1" id="resultF1"></div>
        <div class="result-points" id="resultPoints"></div>
      </div>

      <div class="status-message" id="statusMessage">æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹</div>

      <div class="controls">
        <button id="startBtn" class="btn btn-primary">å¼€å§‹æµ‹è¯•</button>
        <button id="resetBtn" class="btn btn-secondary">é‡ç½®</button>
      </div>
    </div>

    <div class="card" style="margin-top: 30px;">
      <h2 style="color: var(--secondary-color);">ğŸ† æ’è¡Œæ¦œ</h2>
      <div id="season-info" style="margin-bottom: 16px; padding: 12px; background: var(--darker-bg); border-radius: 8px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <span style="color: var(--warning-color);">ğŸ† èµ›å­£: </span>
            <span id="current-season-name" style="color: var(--text-primary);"></span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline" onclick="toggleLeaderboard('all')" id="btn-all-season">å…¨èµ›å­£</button>
            <button class="btn btn-sm btn-primary" onclick="toggleLeaderboard('season')" id="btn-season-only">èµ›å­£</button>
          </div>
        </div>
      </div>
      <div id="leaderboard-container">
        <div class="loading">åŠ è½½ä¸­</div>
      </div>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    // æ¸¸æˆçŠ¶æ€
    let gameState = 'idle'; // idle, starting, ready, finished
    let lightsOn = 0;
    let startTime = 0;
    let lightsTimeout = null;
    let autoResetTimeout = null;
    let currentSeason = null;
    let leaderboardMode = 'all'; // 'all' or 'season'

    // DOM å…ƒç´ 
    const lights = [
      document.getElementById('light1'),
      document.getElementById('light2'),
      document.getElementById('light3'),
      document.getElementById('light4'),
      document.getElementById('light5')
    ];
    const resultDisplay = document.getElementById('resultDisplay');
    const resultTime = document.getElementById('resultTime');
    const resultRank = document.getElementById('resultRank');
    const resultF1 = document.getElementById('resultF1');
    const resultPoints = document.getElementById('resultPoints');
    const statusMessage = document.getElementById('statusMessage');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');

    // F1 è½¦æ‰‹æ•°æ®
    const f1Drivers = [
      { name: 'F1 å¹³å‡æ°´å¹³', time: 0.200 },
      { name: 'é¡¶çº§è½¦æ‰‹', time: 0.180 },
      { name: 'ç»´æ–¯å¡”æ½˜', time: 0.160 },
      { name: 'æ±‰å¯†å°”é¡¿', time: 0.170 },
      { name: 'å‹’å…‹è±å°”', time: 0.175 }
    ];

    // è¯„ä»·ç­‰çº§
    const ranks = [
      { max: 0.150, text: 'ğŸ† è¶…è¶Šè½¦ç¥ï¼', color: '#ffd700' },
      { max: 0.180, text: 'ğŸ¥‡ é¡¶çº§è½¦æ‰‹çº§åˆ«ï¼', color: '#c0c0c0' },
      { max: 0.200, text: 'ğŸ¥ˆ ä¸“ä¸šçº§æ°´å¹³ï¼', color: '#cd7f32' },
      { max: 0.230, text: 'ğŸ¥‰ ä¼˜ç§€ååº”é€Ÿåº¦ï¼', color: '#6366f1' },
      { max: 0.300, text: 'ğŸ‘ è‰¯å¥½ååº”ï¼', color: '#10b981' },
      { max: 0.500, text: 'ğŸ˜Š ç»§ç»­åŠ æ²¹ï¼', color: '#f59e0b' },
      { max: Infinity, text: 'ğŸ’ª å†è¯•ä¸€æ¬¡ï¼', color: '#94a3b8' }
    ];

    // è®¡ç®—ç§¯åˆ†
    function calculatePoints(time) {
      if (time < 0.200) return 100;
      if (time < 0.230) return 80;
      if (time < 0.250) return 60;
      if (time < 0.300) return 40;
      return 20;
    }

    // è·å–è¯„ä»·
    function getRank(time) {
      return ranks.find(r => time < r.max);
    }

    // è·å–å¯¹æ¯”çš„ F1 è½¦æ‰‹
    function getF1Driver(time) {
      for (let driver of f1Drivers) {
        if (time <= driver.time) {
          return `æ¯” ${driver.name} è¿˜è¦å¿«ï¼`;
        }
      }
      return `è·ç¦» F1 å¹³å‡æ°´å¹³è¿˜å·® ${(time - 0.200).toFixed(3)}s`;
    }

    // å¼€å§‹æ¸¸æˆ
    function startGame() {
      if (gameState !== 'idle') return;

      gameState = 'starting';
      lightsOn = 0;
      resultDisplay.style.display = 'none';
      statusMessage.textContent = 'å‡†å¤‡...';
      startBtn.disabled = true;

      // ä¾æ¬¡ç‚¹äº®çº¢ç¯
      lightUp();
    }

    // ç‚¹äº®çº¢ç¯
    function lightUp() {
      if (lightsOn < 5) {
        lights[lightsOn].classList.add('on');
        lightsOn++;
        // çœŸæ­£çš„F1èµ·æ­¥ç¯ï¼šæ¯ä¸ªç¯é—´éš”1ç§’ï¼Œæ€»å…±5ç§’ç‚¹äº®å®Œ
        lightsTimeout = setTimeout(lightUp, 1000);
      } else {
        // æ‰€æœ‰ç¯äº®èµ·ï¼Œç­‰å¾…éšæœºæ—¶é—´åç†„ç­ï¼ˆ0.2-3ç§’ï¼Œæ¨¡æ‹ŸçœŸå®F1éšæœºå»¶è¿Ÿï¼‰
        lightsTimeout = setTimeout(lightsOut, 200 + Math.random() * 2800);
      }
    }

    // ç†„ç­æ‰€æœ‰ç¯ï¼ˆç«‹å³æ‰§è¡Œï¼Œæ— å»¶è¿Ÿï¼‰
    function lightsOut() {
      // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ‰§è¡Œï¼Œé¿å…å¸ƒå±€æŠ–åŠ¨
      requestAnimationFrame(() => {
        lights.forEach(light => {
          light.classList.remove('on');
          light.classList.add('green');
        });

        gameState = 'ready';
        startTime = performance.now();
        statusMessage.textContent = 'ç‚¹å‡»ï¼ï¼ï¼';
      });
    }

    // å¤„ç†ç‚¹å‡»ï¼ˆç¡®ä¿æœ€ä½å»¶è¿Ÿï¼‰
    function handleClick() {
      if (gameState === 'idle') {
        startGame();
      } else if (gameState === 'ready') {
        // ç«‹å³è®°å½•æ—¶é—´ï¼Œä¸ç»è¿‡ä»»ä½•å…¶ä»–æ“ä½œ
        const clickTime = performance.now();
        const reactionTime = (clickTime - startTime) / 1000;
        finishGame(reactionTime);
      } else if (gameState === 'starting') {
        // æŠ¢è·‘
        clearTimeout(lightsTimeout);
        resetGame();
        statusMessage.textContent = 'æŠ¢è·‘äº†ï¼è¯·ç­‰å¾…æ‰€æœ‰ç¯ç†„ç­åå†ç‚¹å‡»';
      }
    }

    // å®Œæˆæ¸¸æˆ
    async function finishGame(time) {
      gameState = 'finished';
      const points = calculatePoints(time);
      const rank = getRank(time);
      const f1Comparison = getF1Driver(time);

      // æ˜¾ç¤ºç»“æœï¼ˆè¿™æ˜¯æœ¬åœ°è®¡ç®—çš„ååº”æ—¶é—´ï¼Œä¸å—ç½‘ç»œå½±å“ï¼‰
      resultTime.textContent = (time * 1000).toFixed(0) + 'ms';
      resultTime.style.color = rank.color;
      resultRank.textContent = rank.text;
      resultRank.style.color = rank.color;
      resultF1.textContent = f1Comparison;
      resultPoints.textContent = `+${points} ç§¯åˆ†`;
      resultDisplay.style.display = 'block';
      statusMessage.textContent = 'æ­£åœ¨ä¸Šä¼ æˆç»©...';
      startBtn.disabled = false;

      // å¼‚æ­¥æäº¤æˆç»©åˆ°æœåŠ¡å™¨ï¼ˆä¸é˜»å¡æ˜¾ç¤ºç»“æœï¼‰
      try {
        const result = await submitScore('f1_reaction', time);
        statusMessage.textContent = `æˆç»©å·²ä¿å­˜ï¼æ€»è®¡ +${result.totalPoints} ç§¯åˆ†ã€‚æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»"å¼€å§‹æµ‹è¯•"å†è¯•ä¸€æ¬¡`;
        // é‡æ–°åŠ è½½æ’è¡Œæ¦œ
        loadLeaderboard();
      } catch (error) {
        console.error('æäº¤æˆç»©å¤±è´¥:', error);
        statusMessage.textContent = 'æˆç»©ä¸Šä¼ å¤±è´¥ï¼ˆæœ¬åœ°æˆç»©å·²è®°å½•ï¼‰ã€‚æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»"å¼€å§‹æµ‹è¯•"å†è¯•ä¸€æ¬¡';
      }

      // 5ç§’åè‡ªåŠ¨é‡ç½®
      autoResetTimeout = setTimeout(() => {
        if (gameState === 'finished') {
          resetGame();
        }
      }, 5000);
    }

    // é‡ç½®æ¸¸æˆ
    function resetGame() {
      clearTimeout(lightsTimeout);
      clearTimeout(autoResetTimeout);

      gameState = 'idle';
      lightsOn = 0;

      lights.forEach(light => {
        light.classList.remove('on', 'green');
      });

      resultDisplay.style.display = 'none';
      statusMessage.textContent = 'æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹';
      startBtn.disabled = false;
    }

    // åŠ è½½å½“å‰èµ›å­£
    async function loadCurrentSeason() {
      try {
        const response = await fetch(`${API_BASE}/api/seasons/active`);
        const data = await response.json();

        if (data.season) {
          currentSeason = data.season;
          const seasonInfoEl = document.getElementById('season-info');
          seasonInfoEl.style.display = 'block';
          document.getElementById('current-season-name').textContent = data.season.name;
        }
      } catch (error) {
        console.error('åŠ è½½èµ›å­£ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åˆ‡æ¢æ’è¡Œæ¦œæ¨¡å¼
    function toggleLeaderboard(mode) {
      leaderboardMode = mode;
      const btnAll = document.getElementById('btn-all-season');
      const btnSeason = document.getElementById('btn-season-only');

      if (mode === 'all') {
        btnAll.className = 'btn btn-sm btn-outline';
        btnSeason.className = 'btn btn-sm btn-primary';
      } else {
        btnAll.className = 'btn btn-sm btn-primary';
        btnSeason.className = 'btn btn-sm btn-outline';
      }

      loadLeaderboard();
    }

    // åŠ è½½æ’è¡Œæ¦œ
    async function loadLeaderboard() {
      const container = document.getElementById('leaderboard-container');

      try {
        let leaderboard;

        if (leaderboardMode === 'season' && currentSeason) {
          // åŠ è½½èµ›å­£æ’è¡Œæ¦œ
          const response = await fetch(`${API_BASE}/api/seasons/${currentSeason.id}/leaderboard/f1_reaction`);
          const data = await response.json();
          leaderboard = data.leaderboard;
        } else {
          // åŠ è½½å…¨èµ›å­£æ’è¡Œæ¦œ
          leaderboard = await getLeaderboard('f1_reaction');
        }

        if (!leaderboard || leaderboard.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">æš‚æ— æ•°æ®</p>';
          return;
        }

        const html = `
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>ç”¨æˆ·</th>
                <th>æˆç»©</th>
                <th>æ—¶é—´</th>
              </tr>
            </thead>
            <tbody>
              ${leaderboard.slice(0, 10).map((item, index) => `
                <tr>
                  <td class="rank-${index + 1}">#${index + 1}</td>
                  <td>${item.username}</td>
                  <td>${(item.score * 1000).toFixed(0)}ms</td>
                  <td>${formatDate(item.played_at)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = '<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥</p>';
      }
    }

    // äº‹ä»¶ç›‘å¬
    startBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      handleClick();
    });

    resetBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      resetGame();
    });

    // é”®ç›˜æ§åˆ¶ï¼ˆç©ºæ ¼é”®ï¼‰
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        handleClick();
      }
    });

    // ç‚¹å‡»æ¸¸æˆåŒºåŸŸè§¦å‘ï¼ˆæŒ‰é’®é™¤å¤–ï¼‰
    const gameArea = document.querySelector('.game-canvas-wrapper');
    if (gameArea) {
      gameArea.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
          handleClick();
        }
      });
    }

    // é¡µé¢åŠ è½½æ—¶åŠ è½½æ’è¡Œæ¦œ
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCurrentSeason();
      loadLeaderboard();
    });
  </script>
</body>
</html>
