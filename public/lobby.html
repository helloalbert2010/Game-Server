<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¸æˆå¤§å… - ä¸“æ³¨åŠ›è®­ç»ƒå¹³å°</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body data-auth-required="true">
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-brand">ğŸ¯ ä¸“æ³¨åŠ›è®­ç»ƒ</div>
    <div class="navbar-nav">
      <div class="user-info">
        <span>æ¬¢è¿, <span data-username>åŠ è½½ä¸­...</span></span>
        <div class="points-badge">
          <span data-points>0</span> ç§¯åˆ†
        </div>
        <a href="/games/f1-reaction" class="btn btn-primary">å¼€å§‹æ¸¸æˆ</a>
        <a href="/admin" class="btn btn-secondary hidden" data-admin-only>ç®¡ç†é¢æ¿</a>
        <button onclick="logout()" class="btn btn-outline">ç™»å‡º</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- èµ›å­£æ ‡é¢˜å—ï¼ˆé»˜è®¤éšè—ï¼Œæœ‰æ´»è·ƒèµ›å­£æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="season-banner hidden" id="season-banner">
      <div class="season-banner-bg"></div>
      <div class="season-banner-content">
        <div class="season-header">
          <div class="season-icon">ğŸ†</div>
          <div class="season-info">
            <div class="season-title" id="season-name">ç¬¬ 1 èµ›å­£</div>
            <div class="season-subtitle" id="season-description">ç²¾è‹±æŒ‘æˆ˜èµ›</div>
          </div>
          <div class="season-status-badge">
            <span class="status-dot"></span>
            è¿›è¡Œä¸­
          </div>
        </div>
        <div class="season-details">
          <div class="season-detail-item">
            <div class="detail-icon">â±ï¸</div>
            <div class="detail-text">
              <div class="detail-label">å‰©ä½™æ—¶é—´</div>
              <div class="detail-value" id="season-remaining">è®¡ç®—ä¸­</div>
            </div>
          </div>
          <div class="season-divider"></div>
          <div class="season-detail-item">
            <div class="detail-icon">ğŸ‘¥</div>
            <div class="detail-text">
              <div class="detail-label">å‚èµ›äººæ•°</div>
              <div class="detail-value" id="season-participants">-</div>
            </div>
          </div>
          <div class="season-divider"></div>
          <div class="season-detail-item">
            <div class="detail-icon">ğŸ¯</div>
            <div class="detail-text">
              <div class="detail-label">ä½ çš„æ’å</div>
              <div class="detail-value" id="season-user-rank">-</div>
            </div>
          </div>
          <div class="season-divider"></div>
          <div class="season-detail-item">
            <div class="detail-icon">â­</div>
            <div class="detail-text">
              <div class="detail-label">èµ›å­£ç§¯åˆ†</div>
              <div class="detail-value" id="season-user-points">-</div>
            </div>
          </div>
        </div>
      </div>
      <div class="season-banner-shine"></div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" data-stat="totalGames">-</div>
        <div class="stat-label">æ¸¸æˆæ¬¡æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" data-stat="totalPointsEarned">-</div>
        <div class="stat-label">ç´¯è®¡ç§¯åˆ†</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" data-stat="completedTasks">-</div>
        <div class="stat-label">å®Œæˆä»»åŠ¡</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" data-stat="bestScore">-</div>
        <div class="stat-label">æœ€ä½³æˆç»©</div>
      </div>
    </div>

    <!-- æ¸¸æˆåŒºåŸŸ -->
    <div class="card" style="margin-bottom: 30px;">
      <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ® é€‰æ‹©æ¸¸æˆ</h2>
      <div class="games-grid">
        <div class="game-card" onclick="window.location.href='/games/f1-reaction'">
          <div class="game-icon">ğŸï¸</div>
          <div class="game-title">F1 ååº”æµ‹è¯•</div>
          <div class="game-description">
            æµ‹è¯•ä½ çš„ååº”é€Ÿåº¦ï¼Œåƒ F1 è½¦æ‰‹ä¸€æ ·å¿«ï¼
            <br><br>
            <strong>ç§¯åˆ†è§„åˆ™ï¼š</strong>
            <br>&lt; 0.200s: 100åˆ†
            <br>0.200-0.230s: 80åˆ†
            <br>0.230-0.250s: 60åˆ†
            <br>0.250-0.300s: 40åˆ†
            <br>&gt; 0.300s: 20åˆ†
          </div>
          <button class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div class="game-card" onclick="window.location.href='/games/schulte-grid'">
          <div class="game-icon">ğŸ”¢</div>
          <div class="game-title">èˆ’å°”ç‰¹æ–¹æ ¼</div>
          <div class="game-description">
            æŒ‰é¡ºåºç‚¹å‡» 1-25 çš„æ•°å­—ï¼Œè®­ç»ƒæ³¨æ„åŠ›ï¼
            <br><br>
            <strong>ç§¯åˆ†è§„åˆ™ï¼š</strong>
            <br>&lt; 20s: 100åˆ†
            <br>20-30s: 80åˆ†
            <br>30-40s: 60åˆ†
            <br>40-50s: 40åˆ†
            <br>&gt; 50s: 20åˆ†
          </div>
          <button class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div class="game-card" onclick="window.location.href='/games/snake'">
          <div class="game-icon">ğŸ</div>
          <div class="game-title">ç»å…¸è´ªåƒè›‡</div>
          <div class="game-description">
            æ§åˆ¶è›‡åƒé£Ÿç‰©ï¼Œé¿å…æ’åˆ°å¢™å£å’Œè‡ªå·±ï¼
            <br><br>
            <strong>ç§¯åˆ†è§„åˆ™ï¼š</strong>
            <br>â‰¥ 500åˆ†: 100åˆ†
            <br>â‰¥ 300åˆ†: 80åˆ†
            <br>â‰¥ 200åˆ†: 60åˆ†
            <br>â‰¥ 100åˆ†: 40åˆ†
            <br>&lt; 100åˆ†: 20åˆ†
          </div>
          <button class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div class="game-card" onclick="window.location.href='/games/breakout'">
          <div class="game-icon">ğŸ§±</div>
          <div class="game-title">ç»å…¸æ‰“ç –å—</div>
          <div class="game-description">
            æ§åˆ¶æŒ¡æ¿åå¼¹çƒï¼Œå‡»ç¢æ‰€æœ‰ç –å—ï¼
            <br><br>
            <strong>ç§¯åˆ†è§„åˆ™ï¼š</strong>
            <br>â‰¥ 2000åˆ†: 100åˆ†
            <br>â‰¥ 1500åˆ†: 80åˆ†
            <br>â‰¥ 1000åˆ†: 60åˆ†
            <br>â‰¥ 500åˆ†: 40åˆ†
            <br>&lt; 500åˆ†: 20åˆ†
          </div>
          <button class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
        </div>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
      <!-- ä»Šæ—¥ä»»åŠ¡ -->
      <div class="card">
        <h2 style="margin-bottom: 20px; color: var(--warning-color);">ğŸ“‹ ä»Šæ—¥ä»»åŠ¡</h2>
        <div id="tasks-container">
          <div class="loading">åŠ è½½ä¸­</div>
        </div>
      </div>

      <!-- æ’è¡Œæ¦œ -->
      <div class="card">
        <h2 style="margin-bottom: 20px; color: var(--secondary-color);">ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ</h2>
        <div id="leaderboard-container">
          <div class="loading">åŠ è½½ä¸­</div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    let currentUser = null;

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      currentUser = await initPage();
      if (currentUser) {
        await loadSeasonData(); // åŠ è½½èµ›å­£ä¿¡æ¯
        await loadUserData();
        await loadTasks();
        await loadLeaderboard();
      }
    });

    // åŠ è½½èµ›å­£æ•°æ®
    async function loadSeasonData() {
      try {
        const season = await getActiveSeason();

        if (!season) {
          // æ²¡æœ‰æ´»è·ƒèµ›å­£ï¼Œéšè—æ¨ªå¹…
          document.getElementById('season-banner').classList.add('hidden');
          return;
        }

        // æ˜¾ç¤ºèµ›å­£æ¨ªå¹…
        const banner = document.getElementById('season-banner');
        banner.classList.remove('hidden');

        // å¡«å……åŸºæœ¬ä¿¡æ¯
        document.getElementById('season-name').textContent = season.name;
        document.getElementById('season-description').textContent = season.description || 'ç²¾å½©èµ›å­£';

        // è®¡ç®—å¹¶æ˜¾ç¤ºå‰©ä½™æ—¶é—´
        const remaining = calculateRemainingTime(season.end_date);
        document.getElementById('season-remaining').textContent = remaining.text;

        // å¯åŠ¨å€’è®¡æ—¶æ›´æ–°ï¼ˆæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼‰
        setInterval(() => {
          const newRemaining = calculateRemainingTime(season.end_date);
          document.getElementById('season-remaining').textContent = newRemaining.text;
        }, 60000);

        // è·å–èµ›å­£ç»Ÿè®¡
        const stats = await getSeasonStats(season.id);
        if (stats) {
          document.getElementById('season-participants').textContent = stats.activeUsers + ' äºº';
        }

        // è·å–èµ›å­£æ’è¡Œæ¦œå’Œç”¨æˆ·æ’å
        const leaderboard = await getSeasonLeaderboard(season.id);
        if (leaderboard && leaderboard.length > 0) {
          const userRankIndex = leaderboard.findIndex(item => item.id === currentUser.id);
          if (userRankIndex >= 0) {
            document.getElementById('season-user-rank').textContent = `#${userRankIndex + 1}`;
          } else {
            document.getElementById('season-user-rank').textContent = 'æœªå‚èµ›';
          }
        }

        // è·å–ç”¨æˆ·åœ¨èµ›å­£ä¸­çš„ç§¯åˆ†ï¼ˆéœ€è¦ä»èµ›å­£æ’è¡Œæ¦œä¸­è·å–ï¼‰
        if (leaderboard && leaderboard.length > 0) {
          const userSeasonData = leaderboard.find(item => item.id === currentUser.id);
          if (userSeasonData) {
            document.getElementById('season-user-points').textContent = userSeasonData.total_points.toLocaleString();
          } else {
            document.getElementById('season-user-points').textContent = '0';
          }
        }

      } catch (error) {
        console.error('åŠ è½½èµ›å­£æ•°æ®å¤±è´¥:', error);
        // å‡ºé”™æ—¶éšè—æ¨ªå¹…
        document.getElementById('season-banner').classList.add('hidden');
      }
    }

    // åŠ è½½ç”¨æˆ·æ•°æ®
    async function loadUserData() {
      try {
        const stats = await getUserStats();
        if (stats) {
          document.querySelector('[data-stat="totalGames"]').textContent = stats.totalGames || 0;
          document.querySelector('[data-stat="totalPointsEarned"]').textContent = stats.totalPointsEarned || 0;
          document.querySelector('[data-stat="completedTasks"]').textContent = stats.completedTasks || 0;

          // æ˜¾ç¤ºæœ€ä½³æˆç»©
          const bestScoreEl = document.querySelector('[data-stat="bestScore"]');
          if (stats.bestF1Reaction) {
            bestScoreEl.textContent = (stats.bestF1Reaction * 1000).toFixed(0) + 'ms';
          } else if (stats.bestSchulteGrid) {
            bestScoreEl.textContent = stats.bestSchulteGrid.toFixed(1) + 's';
          } else {
            bestScoreEl.textContent = '-';
          }
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½ä»Šæ—¥ä»»åŠ¡
    async function loadTasks() {
      const container = document.getElementById('tasks-container');
      try {
        const tasks = await getTodayTasks();
        renderTasks(tasks, container);
      } catch (error) {
        container.innerHTML = '<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥</p>';
      }
    }

    // åŠ è½½æ’è¡Œæ¦œ
    async function loadLeaderboard() {
      const container = document.getElementById('leaderboard-container');
      try {
        const leaderboard = await getLeaderboard('total');

        if (!leaderboard || leaderboard.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">æš‚æ— æ•°æ®</p>';
          return;
        }

        // åªæ˜¾ç¤ºå‰10å
        const top10 = leaderboard.slice(0, 10);

        const html = `
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>æ’å</th>
                <th>ç”¨æˆ·</th>
                <th>ç§¯åˆ†</th>
              </tr>
            </thead>
            <tbody>
              ${top10.map((item, index) => `
                <tr>
                  <td class="rank-${index + 1}">#${index + 1}</td>
                  <td>${item.username}${item.id === currentUser.id ? ' (ä½ )' : ''}</td>
                  <td>â­ ${item.points}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = '<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥</p>';
      }
    }
  </script>
</body>
</html>
