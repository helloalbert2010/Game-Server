<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†é¢æ¿ - ä¸“æ³¨åŠ›è®­ç»ƒå¹³å°</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .admin-container {
      display: flex;
      gap: 24px;
    }

    .admin-sidebar {
      width: 250px;
      flex-shrink: 0;
    }

    .admin-sidebar-item {
      display: block;
      width: 100%;
      padding: 16px 20px;
      background: var(--card-bg);
      border: none;
      color: var(--text-secondary);
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .admin-sidebar-item:hover {
      background: var(--card-hover);
      color: var(--primary-color);
    }

    .admin-sidebar-item.active {
      background: var(--primary-color);
      color: white;
    }

    .admin-content {
      flex: 1;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .admin-table th,
    .admin-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .admin-table th {
      background: var(--darker-bg);
      color: var(--text-secondary);
      font-weight: 600;
    }

    .admin-table tr:hover {
      background: var(--card-hover);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 32px;
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .admin-panel {
      display: none;
    }

    .admin-panel.active {
      display: block;
    }

    .search-box {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--darker-bg);
      color: var(--text-primary);
      font-size: 16px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--secondary-color);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger-color);
    }
  </style>
</head>
<body data-auth-required="true">
  <div class="container">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
      <div class="navbar-brand">ğŸ¯ ç®¡ç†é¢æ¿</div>
      <div class="navbar-nav">
        <div class="user-info">
          <span>ç®¡ç†å‘˜: <span data-username>åŠ è½½ä¸­...</span></span>
          <a href="/lobby" class="btn btn-outline">è¿”å›å¤§å…</a>
          <button onclick="logout()" class="btn btn-danger">ç™»å‡º</button>
        </div>
      </div>
    </nav>

    <div class="admin-container">
      <!-- ä¾§è¾¹æ  -->
      <div class="admin-sidebar">
        <button class="admin-sidebar-item active" data-panel="dashboard">
          ğŸ“Š ä»ªè¡¨ç›˜
        </button>
        <button class="admin-sidebar-item" data-panel="users">
          ğŸ‘¥ ç”¨æˆ·ç®¡ç†
        </button>
        <button class="admin-sidebar-item" data-panel="scores">
          ğŸ® æ¸¸æˆè®°å½•
        </button>
        <button class="admin-sidebar-item" data-panel="tasks">
          ğŸ“‹ ä»»åŠ¡ç®¡ç†
        </button>
        <button class="admin-sidebar-item" onclick="window.location.href='/admin/seasons'">
          ğŸ† èµ›å­£ç®¡ç†
        </button>
      </div>

      <!-- ä¸»å†…å®¹åŒº -->
      <div class="admin-content">
        <!-- ä»ªè¡¨ç›˜ -->
        <div id="dashboard-panel" class="admin-panel active">
          <div class="admin-header">
            <h1>ğŸ“Š å¹³å°ç»Ÿè®¡</h1>
          </div>

          <div class="admin-stats">
            <div class="stat-card">
              <div class="stat-value" id="totalUsers">-</div>
              <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalScores">-</div>
              <div class="stat-label">æ¸¸æˆæ€»æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalPoints">-</div>
              <div class="stat-label">ç´¯è®¡å‘æ”¾ç§¯åˆ†</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="todayActive">-</div>
              <div class="stat-label">ä»Šæ—¥æ´»è·ƒç”¨æˆ·</div>
            </div>
          </div>

          <div class="card">
            <h2 style="margin-bottom: 20px;">å¿«é€Ÿæ“ä½œ</h2>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="showPanel('users')">ç®¡ç†ç”¨æˆ·</button>
              <button class="btn btn-secondary" onclick="showPanel('tasks')">ç®¡ç†ä»»åŠ¡</button>
              <button class="btn btn-outline" onclick="refreshDashboard()">åˆ·æ–°æ•°æ®</button>
            </div>
          </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç† -->
        <div id="users-panel" class="admin-panel">
          <div class="admin-header">
            <h1>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h1>
            <button class="btn btn-primary" onclick="showEditUserModal()">+ æ·»åŠ ç”¨æˆ·</button>
          </div>

          <input type="text" class="search-box" id="userSearch" placeholder="æœç´¢ç”¨æˆ·...">

          <div class="card">
            <div id="users-table-container">
              <div class="loading">åŠ è½½ä¸­</div>
            </div>
          </div>
        </div>

        <!-- æ¸¸æˆè®°å½• -->
        <div id="scores-panel" class="admin-panel">
          <div class="admin-header">
            <h1>ğŸ® æ¸¸æˆè®°å½•</h1>
          </div>

          <div class="card">
            <div id="scores-table-container">
              <div class="loading">åŠ è½½ä¸­</div>
            </div>
          </div>
        </div>

        <!-- ä»»åŠ¡ç®¡ç† -->
        <div id="tasks-panel" class="admin-panel">
          <div class="admin-header">
            <h1>ğŸ“‹ ä»»åŠ¡ç®¡ç†</h1>
          </div>

          <div class="card">
            <div id="tasks-table-container">
              <div class="loading">åŠ è½½ä¸­</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="editUserTitle">ç¼–è¾‘ç”¨æˆ·</h3>
        <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
      </div>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">

        <div class="form-group">
          <label for="editUsername">ç”¨æˆ·å</label>
          <input type="text" id="editUsername" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="editPoints">ç§¯åˆ†</label>
          <input type="number" id="editPoints" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="editPassword">æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
          <input type="password" id="editPassword" class="form-control">
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="editIsAdmin">
            ç®¡ç†å‘˜æƒé™
          </label>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          <button type="button" class="btn btn-outline" onclick="closeModal('editUserModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/main.js"></script>
  <script>
    // å·¥å…·å‡½æ•°ï¼šå‘é€ç®¡ç†å‘˜ API è¯·æ±‚
    async function adminApiRequest(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}/api/admin${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
      }

      return data;
    }

    // é¢æ¿åˆ‡æ¢
    function showPanel(panelName) {
      // æ›´æ–°ä¾§è¾¹æ 
      document.querySelectorAll('.admin-sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.panel === panelName) {
          item.classList.add('active');
        }
      });

      // æ›´æ–°é¢æ¿æ˜¾ç¤º
      document.querySelectorAll('.admin-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(`${panelName}-panel`).classList.add('active');

      // åŠ è½½å¯¹åº”æ•°æ®
      if (panelName === 'dashboard') {
        loadDashboard();
      } else if (panelName === 'users') {
        loadUsers();
      } else if (panelName === 'scores') {
        loadScores();
      } else if (panelName === 'tasks') {
        loadTasks();
      }
    }

    // ä¾§è¾¹æ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.admin-sidebar-item').forEach(item => {
      item.addEventListener('click', () => {
        showPanel(item.dataset.panel);
      });
    });

    // åŠ è½½ä»ªè¡¨ç›˜
    async function loadDashboard() {
      try {
        const data = await adminApiRequest('/stats');
        const stats = data.stats;

        document.getElementById('totalUsers').textContent = stats.totalUsers;
        document.getElementById('totalScores').textContent = stats.totalScores;
        document.getElementById('totalPoints').textContent = stats.totalPointsAwarded;
        document.getElementById('todayActive').textContent = stats.todayActiveUsers;
      } catch (error) {
        showToast('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message, 'error');
      }
    }

    function refreshDashboard() {
      loadDashboard();
    }

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
      const container = document.getElementById('users-table-container');
      showLoading(container);

      try {
        const data = await adminApiRequest('/users');
        const users = data.users;

        if (users.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">æš‚æ— ç”¨æˆ·</p>';
          return;
        }

        const html = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ç”¨æˆ·å</th>
                <th>ç§¯åˆ†</th>
                <th>è§’è‰²</th>
                <th>æ³¨å†Œæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr>
                  <td>${user.id}</td>
                  <td>${user.username}</td>
                  <td>â­ ${user.points}</td>
                  <td>
                    ${user.isAdmin === 1
                      ? '<span class="badge badge-danger">ç®¡ç†å‘˜</span>'
                      : '<span class="badge badge-success">ç”¨æˆ·</span>'
                    }
                  </td>
                  <td>${formatDate(user.created_at)}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                      ${user.isAdmin !== 1 ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">åˆ é™¤</button>` : ''}
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }

    // åŠ è½½æ¸¸æˆè®°å½•
    async function loadScores() {
      const container = document.getElementById('scores-table-container');
      showLoading(container);

      try {
        const data = await adminApiRequest('/scores');
        const scores = data.scores;

        if (scores.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">æš‚æ— è®°å½•</p>';
          return;
        }

        const html = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ç”¨æˆ·</th>
                <th>æ¸¸æˆç±»å‹</th>
                <th>æˆç»©</th>
                <th>ç§¯åˆ†</th>
                <th>æ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${scores.slice(0, 100).map(score => `
                <tr>
                  <td>${score.id}</td>
                  <td>${score.username}</td>
                  <td>${score.game_type === 'f1_reaction' ? 'ğŸï¸ F1ååº”' : 'ğŸ”¢ èˆ’å°”ç‰¹æ–¹æ ¼'}</td>
                  <td>${score.game_type === 'f1_reaction'
                    ? (score.score * 1000).toFixed(0) + 'ms'
                    : score.score.toFixed(2) + 's'
                  }</td>
                  <td>+${score.points_earned}</td>
                  <td>${formatDate(score.played_at)}</td>
                  <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteScore(${score.id})">åˆ é™¤</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }

    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
    async function loadTasks() {
      const container = document.getElementById('tasks-table-container');
      showLoading(container);

      try {
        const data = await adminApiRequest('/tasks');
        const tasks = data.tasks;

        if (tasks.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">æš‚æ— ä»»åŠ¡</p>';
          return;
        }

        const html = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>æ—¥æœŸ</th>
                <th>æ¸¸æˆç±»å‹</th>
                <th>æè¿°</th>
                <th>ç›®æ ‡</th>
                <th>å¥–åŠ±</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${tasks.map(task => `
                <tr>
                  <td>${task.id}</td>
                  <td>${task.task_date}</td>
                  <td>${task.game_type === 'f1_reaction' ? 'ğŸï¸ F1ååº”' : 'ğŸ”¢ èˆ’å°”ç‰¹æ–¹æ ¼'}</td>
                  <td>${task.description || '-'}</td>
                  <td>${task.target_score}</td>
                  <td>â­ ${task.points_reward}</td>
                  <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">åˆ é™¤</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<p class="text-center" style="color: var(--danger-color);">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }

    // ç¼–è¾‘ç”¨æˆ·
    async function editUser(userId) {
      try {
        const data = await adminApiRequest(`/users/${userId}`);
        const user = data.user;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editPoints').value = user.points;
        document.getElementById('editPassword').value = '';
        document.getElementById('editIsAdmin').checked = user.isAdmin === 1;
        document.getElementById('editUserTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';

        openModal('editUserModal');
      } catch (error) {
        showToast('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ·»åŠ ç”¨æˆ·
    function showEditUserModal() {
      document.getElementById('editUserId').value = '';
      document.getElementById('editUsername').value = '';
      document.getElementById('editPoints').value = 0;
      document.getElementById('editPassword').value = '';
      document.getElementById('editPassword').required = true;
      document.getElementById('editIsAdmin').checked = false;
      document.getElementById('editUserTitle').textContent = 'æ·»åŠ ç”¨æˆ·';

      openModal('editUserModal');
    }

    // ä¿å­˜ç”¨æˆ·
    document.getElementById('editUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const userId = document.getElementById('editUserId').value;
      const username = document.getElementById('editUsername').value;
      const points = parseInt(document.getElementById('editPoints').value);
      const password = document.getElementById('editPassword').value;
      const isAdmin = document.getElementById('editIsAdmin').checked ? 1 : 0;

      try {
        const userData = { username, points, isAdmin };
        if (password) {
          userData.password = password;
        }

        if (userId) {
          await adminApiRequest(`/users/${userId}`, {
            method: 'PUT',
            body: JSON.stringify(userData)
          });
          showToast('ç”¨æˆ·æ›´æ–°æˆåŠŸ', 'success');
        } else {
          await fetch(`${API_BASE}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });
          showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
        }

        closeModal('editUserModal');
        loadUsers();
      } catch (error) {
        showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });

    // åˆ é™¤ç”¨æˆ·
    async function deleteUser(userId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        return;
      }

      try {
        await adminApiRequest(`/users/${userId}`, { method: 'DELETE' });
        showToast('ç”¨æˆ·å·²åˆ é™¤', 'success');
        loadUsers();
      } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ é™¤æˆç»©
    async function deleteScore(scoreId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æˆç»©è®°å½•å—ï¼Ÿ')) {
        return;
      }

      try {
        await adminApiRequest(`/scores/${scoreId}`, { method: 'DELETE' });
        showToast('è®°å½•å·²åˆ é™¤', 'success');
        loadScores();
      } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ é™¤ä»»åŠ¡
    async function deleteTask(taskId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ')) {
        return;
      }

      try {
        await adminApiRequest(`/tasks/${taskId}`, { method: 'DELETE' });
        showToast('ä»»åŠ¡å·²åˆ é™¤', 'success');
        loadTasks();
      } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ¨¡æ€æ¡†æ§åˆ¶
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(container) {
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
    }

    // ç”¨æˆ·æœç´¢
    let searchTimeout;
    document.getElementById('userSearch')?.addEventListener('input', function(e) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        // è¿™é‡Œå¯ä»¥å®ç°æœç´¢åŠŸèƒ½
        // ç›®å‰ç®€åŒ–ä¸ºé‡æ–°åŠ è½½æ‰€æœ‰ç”¨æˆ·
        loadUsers();
      }, 300);
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      const user = await initPage();
      if (user && user.isAdmin) {
        loadDashboard();
      } else if (user) {
        showToast('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™', 'error');
        setTimeout(() => {
          window.location.href = '/lobby';
        }, 2000);
      }
    });
  </script>
</body>
</html>
